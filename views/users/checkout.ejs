 
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - boAt | Premium Audio Experience</title>
    <meta name="description" content="Complete your purchase with boAtâ€™s premium audio gear.">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Bootstrap for Grid System -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }

        /* Breadcrumb */
        .breadcrumb-wrap {
            background-color: #fff;
            padding: 15px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .breadcrumb {
            margin: 0;
            padding: 0;
            background: none;
            font-size: 14px;
        }

        .breadcrumb-item a {
            color: #00c4cc;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .breadcrumb-item a:hover {
            color: #1a8b90;
        }

        .breadcrumb-item.active {
            color: #6b7280;
        }

        /* Checkout Section */
        .checkout-section {
            padding: 60px 0;
        }

        .card {
            background-color: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .card-body {
            padding: 30px;
        }

        h3 {
            font-size: 28px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 30px;
            text-align: center;
        }

        h5 {
            font-size: 18px;
            font-weight: 600;
            color: #00c4cc;
            margin-bottom: 20px;
        }

        /* Order Review */
        .order-review .table {
            margin-bottom: 0;
            border-collapse: collapse;
        }

        .order-review th,
        .order-review td {
            padding: 15px;
            font-size: 15px;
            border-bottom: 1px solid #e5e7eb;
        }

        .order-review th {
            font-weight: 600;
            color: #374151;
            text-transform: uppercase;
            background-color: #f9fafb;
        }

        .product-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .product-info img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .product-info a {
            color: #1f2937;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
        }

        .product-info a:hover {
            color: #00c4cc;
        }

        .total-row {
            font-weight: 700;
            background-color: #f9fafb;
        }

        .text-success {
            color: #10b981 !important;
        }

        /* Coupon Section */
        .coupon-section .input-group {
            max-width: 400px;
        }

        .form-control {
            border: 1px solid #d1d5db;
            border-radius: 8px 0 0 8px;
            padding: 10px 15px;
            font-size: 15px;
            color: #1f2937;
        }

        .form-control:focus {
            border-color: #00c4cc;
            box-shadow: 0 0 0 3px rgba(0, 196, 204, 0.1);
            outline: none;
        }

        .btn-primary {
            background-color: #00c4cc;
            border-color: #00c4cc;
            color: #fff;
            padding: 10px 20px;
            font-size: 15px;
            font-weight: 500;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background-color: #1a8b90;
            border-color: #1a8b90;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .btn-outline-danger {
            border-color: #ef4444;
            color: #ef4444;
            padding: 10px 20px;
            font-size: 15px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .btn-outline-danger:hover {
            background-color: #ef4444;
            color: #fff;
        }

        .coupon-list {
            max-height: 150px;
            overflow-y: auto;
            padding: 10px;
            background-color: #f9fafb;
            border-radius: 8px;
            font-size: 14px;
            color: #4b5563;
        }

        .coupon-list ul {
            margin: 0;
            padding-left: 20px;
        }

        /* Address Section */
        .address-card {
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .address-card:hover {
            border-color: #00c4cc;
            box-shadow: 0 4px 12px rgba(0, 196, 204, 0.1);
        }

        .form-check-input:checked + .form-check-label {
            color: #00c4cc;
            font-weight: 500;
        }

        .form-check-input:checked {
            background-color: #00c4cc;
            border-color: #00c4cc;
        }

        .form-check-label {
            font-size: 15px;
            color: #4b5563;
        }

        .btn-outline-primary {
            border-color: #00c4cc;
            color: #00c4cc;
            padding: 10px 20px;
            font-size: 15px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .btn-outline-primary:hover {
            background-color: #00c4cc;
            color: #fff;
        }

        /* Payment Section */
        .payment-options .form-check {
            margin-bottom: 15px;
        }

        .payment-options .form-check-input {
            margin-top: 3px;
        }

        .payment-options .form-check-label {
            font-size: 15px;
            color: #4b5563;
        }

        /* Place Order Button */
        .btn-primary.w-100 {
            padding: 14px;
            font-size: 16px;
            font-weight: 600;
            text-transform: uppercase;
        }

        /* Responsive Design */
        @media (max-width: 767px) {
            .checkout-section {
                padding: 40px 0;
            }

            h3 {
                font-size: 24px;
            }

            h5 {
                font-size: 16px;
            }

            .order-review th,
            .order-review td {
                padding: 10px;
                font-size: 14px;
            }

            .product-info img {
                width: 45px;
                height: 45px;
            }

            .product-info a {
                font-size: 14px;
            }

            .coupon-section .input-group {
                flex-wrap: wrap;
                gap: 10px;
            }

            .form-control,
            .btn-primary,
            .btn-outline-danger {
                font-size: 14px;
                padding: 8px 15px;
            }

            .address-card .card-body {
                padding: 15px;
            }

            .form-check-label {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <%- include('../layouts/header') %>

    <main class="main checkout-page">
        <!-- Breadcrumb -->
        <div class="page-header breadcrumb-wrap">
            <div class="container">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/">Home</a></li>
                        <li class="breadcrumb-item"><a href="/shop">Shop</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Checkout</li>
                    </ol>
                </nav>
            </div>
        </div>

        <!-- Checkout Section -->
        <section class="checkout-section">
            <div class="container">
                <div class="row justify-content-center">
                    <div class="col-lg-8 col-md-10">
                        <div class="card order-summary">
                            <div class="card-body">
                                <h3>Checkout</h3>

                                <!-- Order Review -->
                                <div class="order-review mb-5">
                                    <h5>Your Order</h5>
                                    <div class="table-responsive">
                                        <table class="table order-table">
                                            <thead>
                                                <tr>
                                                    <th>Product</th>
                                                    <th>Qty</th>
                                                    <th>Total</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% if (cart?.items?.length > 0) { %>
                                                    <% cart.items.forEach(product => { %>
                                                        <tr>
                                                            <td class="product-info">
                                                                <img src="<%= product.productId?.additionalimages?.[0] ? '/' + product.productId.additionalimages[0] : '/assets/imgs/placeholder.jpg' %>" 
                                                                     alt="<%= product.productId?.name || 'Product' %>">
                                                                <a href="/product/<%= product.productId?._id %>">
                                                                    <%= product.productId?.name || 'Product Name Unavailable' %>
                                                                </a>
                                                            </td>
                                                            <td>x<%= product.quantity %></td>
                                                            <td>â‚¹<%= product.subTotal.toFixed(2) %></td>
                                                        </tr>
                                                    <% }); %>
                                                    <tr>
                                                        <th>Subtotal</th>
                                                        <td colspan="2">â‚¹<%= totalSubtotal.toFixed(2) %></td>
                                                    </tr>
                                                    <tr>
                                                        <th>Shipping</th>
                                                        <td colspan="2" class="text-success">Free</td>
                                                    </tr>
                                                    <tr>
                                                        <th>Discount</th>
                                                        <td colspan="2" id="discount">â‚¹0</td>
                                                    </tr>
                                                    <tr class="total-row">
                                                        <th>Total</th>
                                                        <td colspan="2" id="totalprice">â‚¹<%= totalSubtotal.toFixed(2) %></td>
                                                    </tr>
                                                <% } else { %>
                                                    <tr>
                                                        <td colspan="3" class="text-center">Your cart is empty</td>
                                                    </tr>
                                                <% } %>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- Coupon Section -->
                                <div class="coupon-section mb-5">
                                    <h5>Apply Coupon</h5>
                                    <div class="input-group mb-3">
                                        <input type="text" id="couponcode" class="form-control" placeholder="Enter Coupon Code" 
                                               oninput="this.value = this.value.toUpperCase()">
                                        <button class="btn btn-primary" onclick="applycoupon()">Apply</button>
                                        <button id="cancelCouponBtn" class="btn btn-outline-danger" onclick="cancelCoupon()" 
                                                style="display:none;">Cancel</button>
                                    </div>
                                    <p id="couponmessage" class="text-success mb-0"></p>
                                    <% if (coupons?.length) { %>
                                        <div class="coupon-list mt-3">
                                            <h6>Available Coupons:</h6>
                                            <ul class="list-unstyled">
                                                <% coupons.forEach(coupon => { %>
                                                    <li><%= coupon.code %> - <%= coupon.discount %>% off (Min: â‚¹<%= coupon.minAmt %>)</li>
                                                <% }); %>
                                            </ul>
                                        </div>
                                    <% } %>
                                </div>

                                <!-- Address Selection -->
                                <div class="address-section mb-5">
                                    <h5>Delivery Address</h5>
                                    <% if (addressData?.address?.length) { %>
                                        <div class="row">
                                            <% addressData.address.forEach((addr, i) => { %>
                                                <div class="col-md-6 mb-3">
                                                    <div class="card address-card">
                                                        <div class="card-body">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="radio" name="selectedAddress" 
                                                                       id="addressRadio<%= i %>" value="<%= addr._id %>" <%= i === 0 ? 'checked' : '' %>>
                                                                <label class="form-check-label" for="addressRadio<%= i %>">
                                                                    <%= addr.house %>, <%= addr.landmark %><br>
                                                                    <%= addr.city %>, <%= addr.state %> <%= addr.zipcode %><br>
                                                                    <%= addr.country %>
                                                                </label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            <% }); %>
                                        </div>
                                    <% } else { %>
                                        <p>No addresses found.</p>
                                        <a href="/addnewaddress?from=checkout" class="btn btn-outline-primary">Add Address</a>
                                    <% } %>
                                </div>

                                <!-- Payment Methods -->
                                <div class="payment-section mb-5">
                                    <h5>Payment Method</h5>
                                    <div class="payment-options">
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="radio" name="payment_option" id="cod" 
                                                   value="Cash on delivery" checked>
                                            <label class="form-check-label" for="cod">Cash on Delivery</label>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="radio" name="payment_option" id="online" 
                                                   value="Online Payment">
                                            <label class="form-check-label" for="online">Online Payment</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="payment_option" id="wallet" 
                                                   value="Wallet">
                                            <label class="form-check-label" for="wallet">Wallet</label>
                                        </div>
                                    </div>
                                </div>

                                <!-- Place Order -->
                                <button id="placeOrderBtn" class="btn btn-primary w-100">Place Order</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Scripts -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        let originalTotal = parseFloat("<%= totalSubtotal ? totalSubtotal.toFixed(2) : '0.00' %>");
        let appliedDiscount = 0;
        let appliedCouponCode = '';

        async function applycoupon() {
            const couponCode = document.getElementById('couponcode').value.trim();
            if (!couponCode) {
                Swal.fire('Error', 'Please enter a coupon code', 'error');
                return;
            }

            try {
                const response = await fetch('/applycoupon', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ couponCode, totalPrice: originalTotal })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const data = await response.json();

                document.getElementById('couponmessage').textContent = data.message;
                if (data.total) {
                    appliedDiscount = parseFloat(data.discount);
                    appliedCouponCode = couponCode;
                    document.getElementById('discount').textContent = `â‚¹${appliedDiscount.toFixed(2)}`;
                    document.getElementById('totalprice').textContent = `â‚¹${(originalTotal - appliedDiscount).toFixed(2)}`;
                    document.getElementById('cancelCouponBtn').style.display = 'inline-block';
                }
            } catch (error) {
                console.error('Coupon error:', error);
                Swal.fire('Error', 'Failed to apply coupon', 'error');
            }
        }

        async function cancelCoupon() {
            if (!appliedCouponCode) {
                document.getElementById('couponmessage').textContent = 'No coupon applied';
                return;
            }

            try {
                const response = await fetch('/cancelcoupon', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ couponCode: appliedCouponCode })
                });

                if (!response.ok) {
                    const text = await response.text();
                    console.error('Cancel coupon response:', text);
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const data = await response.json();

                document.getElementById('couponmessage').textContent = data.message;
                document.getElementById('couponcode').value = '';
                document.getElementById('discount').textContent = 'â‚¹0';
                document.getElementById('totalprice').textContent = `â‚¹${originalTotal.toFixed(2)}`;
                document.getElementById('cancelCouponBtn').style.display = 'none';
                appliedDiscount = 0;
                appliedCouponCode = '';
            } catch (error) {
                console.error('Cancel coupon error:', error.message);
                Swal.fire('Error', error.message.includes('401') ? 'Please log in to cancel coupon' : 'Failed to cancel coupon', 'error');
            }
        }

        document.getElementById('placeOrderBtn').addEventListener('click', async (e) => {
            e.preventDefault();

            const selectedAddress = document.querySelector('input[name="selectedAddress"]:checked');
            if (!selectedAddress) {
                Swal.fire('Error', 'Please select a delivery address', 'error');
                return;
            }

            const paymentOption = document.querySelector('input[name="payment_option"]:checked').value;
            const totalPrice = originalTotal - appliedDiscount;

            if (totalPrice > 1000 && paymentOption === 'Cash on delivery') {
                Swal.fire('Error', 'Cash on Delivery not available for orders above â‚¹1000', 'error');
                return;
            }

            const orderData = {
                addressId: selectedAddress.value,
                cartSubtotal: totalPrice,
                paymentOption,
                discount: appliedDiscount,
                couponCode: appliedCouponCode
            };

            try {
                const response = await fetch('/placeorder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    if (paymentOption === 'Online Payment') {
                        const options = {
                            key: 'rzp_test_ihsNz6lracNIu3',
                            amount: result.orderAmount,
                            currency: 'INR',
                            name: 'Your Store',
                            description: 'Order Payment',
                            order_id: result.orderId,
                            handler: (response) => {
                                updatePaymentStatus('success', result.orderId);
                                window.location.href = '/ordersuccess';
                            },
                            prefill: { name: 'Customer', email: 'customer@example.com', contact: '1234567890' }
                        };

                        const rzp = new Razorpay(options);
                        rzp.on('payment.failed', (response) => {
                            updatePaymentStatus('failed', result.orderId);
                            Swal.fire('Error', 'Payment cancelled', 'error');
                            window.location.href = '/retryorder';
                        });
                        rzp.open();
                    } else {
                        window.location.href = '/ordersuccess';
                    }
                } else {
                    Swal.fire('Error', 'Failed to place order', 'error');
                }
            } catch (error) {
                console.error('Order error:', error);
                Swal.fire('Error', 'Something went wrong', 'error');
            }
        });

        function updatePaymentStatus(status, orderId) {
            fetch('/paymentstatus', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status, orderId })
            }).catch(error => console.error('Payment status error:', error));
        }
    </script>
</body>
</html>
 